package symbols

import (
	"fmt"
	"image"
	"image/color"
	"image/png"
	"os"
	"testing"
)

// three versions of a 'a'
var symbols_a = []Symbol{
	{{
		{X: 24.00, Y: 18.30}, {X: 23.00, Y: 17.30}, {X: 22.00, Y: 17.30}, {X: 21.00, Y: 17.30}, {X: 20.00, Y: 17.30}, {X: 19.00, Y: 17.30}, {X: 18.00, Y: 17.30}, {X: 18.00, Y: 18.30}, {X: 17.00, Y: 18.30}, {X: 17.00, Y: 20.30}, {X: 16.00, Y: 21.30}, {X: 16.00, Y: 22.30}, {X: 16.00, Y: 24.30}, {X: 16.00, Y: 25.30}, {X: 17.00, Y: 27.30}, {X: 17.00, Y: 28.30}, {X: 18.00, Y: 29.30}, {X: 19.00, Y: 29.30}, {X: 20.00, Y: 29.30}, {X: 21.00, Y: 29.30}, {X: 22.00, Y: 29.30}, {X: 23.00, Y: 28.30}, {X: 23.00, Y: 26.30}, {X: 24.00, Y: 25.30}, {X: 24.00, Y: 23.30}, {X: 24.00, Y: 21.30}, {X: 24.00, Y: 19.30}, {X: 24.00, Y: 17.30}, {X: 24.00, Y: 16.30}, {X: 24.00, Y: 15.30}, {X: 23.00, Y: 15.30}, {X: 23.00, Y: 16.30}, {X: 23.00, Y: 17.30}, {X: 23.00, Y: 19.30}, {X: 23.00, Y: 21.30}, {X: 24.00, Y: 23.30}, {X: 25.00, Y: 24.30}, {X: 26.00, Y: 26.30}, {X: 27.00, Y: 27.30}, {X: 28.00, Y: 28.30}, {X: 29.00, Y: 28.30}, {X: 30.00, Y: 29.30}, {X: 31.00, Y: 29.30}, {X: 32.00, Y: 29.30},
	}},
	{{
		{X: 21.00, Y: 18.30}, {X: 21.00, Y: 17.30}, {X: 20.00, Y: 17.30}, {X: 19.00, Y: 17.30}, {X: 18.00, Y: 17.30}, {X: 17.00, Y: 17.30}, {X: 16.00, Y: 18.30}, {X: 15.00, Y: 19.30}, {X: 14.00, Y: 20.30}, {X: 13.00, Y: 21.30}, {X: 12.00, Y: 23.30}, {X: 11.00, Y: 24.30}, {X: 10.00, Y: 26.30}, {X: 10.00, Y: 27.30}, {X: 10.00, Y: 29.30}, {X: 10.00, Y: 30.30}, {X: 10.00, Y: 31.30}, {X: 11.00, Y: 32.30}, {X: 11.00, Y: 33.30}, {X: 12.00, Y: 33.30}, {X: 13.00, Y: 34.30}, {X: 15.00, Y: 34.30}, {X: 16.00, Y: 34.30}, {X: 17.00, Y: 33.30}, {X: 18.00, Y: 32.30}, {X: 19.00, Y: 32.30}, {X: 19.00, Y: 30.30}, {X: 19.00, Y: 29.30}, {X: 19.00, Y: 28.30}, {X: 19.00, Y: 27.30}, {X: 19.00, Y: 26.30}, {X: 19.00, Y: 25.30}, {X: 18.00, Y: 25.30}, {X: 18.00, Y: 26.30}, {X: 18.00, Y: 27.30}, {X: 19.00, Y: 28.30}, {X: 19.00, Y: 29.30}, {X: 20.00, Y: 30.30}, {X: 21.00, Y: 30.30}, {X: 21.00, Y: 31.30}, {X: 22.00, Y: 31.30}, {X: 23.00, Y: 32.30}, {X: 24.00, Y: 32.30}, {X: 25.00, Y: 32.30}, {X: 26.00, Y: 32.30}, {X: 27.00, Y: 32.30}, {X: 28.00, Y: 32.30}, {X: 29.00, Y: 32.30}, {X: 30.00, Y: 32.30}, {X: 31.00, Y: 32.30},
	}},
	{{
		{X: 21.00, Y: 15.30}, {X: 20.00, Y: 15.30}, {X: 19.00, Y: 15.30}, {X: 19.00, Y: 14.30}, {X: 18.00, Y: 14.30}, {X: 17.00, Y: 14.30}, {X: 16.00, Y: 14.30}, {X: 15.00, Y: 14.30}, {X: 14.00, Y: 15.30}, {X: 13.00, Y: 16.30}, {X: 12.00, Y: 18.30}, {X: 12.00, Y: 19.30}, {X: 12.00, Y: 21.30}, {X: 11.00, Y: 22.30}, {X: 11.00, Y: 24.30}, {X: 12.00, Y: 25.30}, {X: 12.00, Y: 26.30}, {X: 13.00, Y: 27.30}, {X: 14.00, Y: 28.30}, {X: 15.00, Y: 28.30}, {X: 16.00, Y: 29.30}, {X: 17.00, Y: 29.30}, {X: 18.00, Y: 28.30}, {X: 19.00, Y: 28.30}, {X: 20.00, Y: 27.30}, {X: 20.00, Y: 25.30}, {X: 21.00, Y: 23.30}, {X: 21.00, Y: 21.30}, {X: 21.00, Y: 20.30}, {X: 22.00, Y: 18.30}, {X: 22.00, Y: 17.30}, {X: 22.00, Y: 16.30}, {X: 21.00, Y: 15.30}, {X: 21.00, Y: 16.30}, {X: 21.00, Y: 17.30}, {X: 21.00, Y: 19.30}, {X: 21.00, Y: 21.30}, {X: 22.00, Y: 23.30}, {X: 24.00, Y: 25.30}, {X: 25.00, Y: 26.30}, {X: 26.00, Y: 28.30}, {X: 27.00, Y: 29.30}, {X: 29.00, Y: 29.30}, {X: 30.00, Y: 30.30}, {X: 31.00, Y: 30.30}, {X: 32.00, Y: 30.30}, {X: 33.00, Y: 30.30},
	}},
}

var symbols_b = []Symbol{
	{{
		{X: 21.00, Y: 6.30}, {X: 20.00, Y: 6.30}, {X: 20.00, Y: 5.30}, {X: 20.00, Y: 6.30}, {X: 20.00, Y: 7.30}, {X: 21.00, Y: 8.30}, {X: 21.00, Y: 10.30}, {X: 22.00, Y: 13.30}, {X: 22.00, Y: 15.30}, {X: 23.00, Y: 18.30}, {X: 23.00, Y: 20.30}, {X: 24.00, Y: 22.30}, {X: 24.00, Y: 23.30}, {X: 24.00, Y: 24.30}, {X: 25.00, Y: 25.30}, {X: 25.00, Y: 24.30}, {X: 25.00, Y: 23.30}, {X: 25.00, Y: 22.30}, {X: 25.00, Y: 21.30}, {X: 25.00, Y: 19.30}, {X: 25.00, Y: 18.30}, {X: 25.00, Y: 17.30}, {X: 26.00, Y: 17.30}, {X: 27.00, Y: 18.30}, {X: 29.00, Y: 19.30}, {X: 30.00, Y: 20.30}, {X: 30.00, Y: 21.30}, {X: 31.00, Y: 22.30}, {X: 31.00, Y: 24.30}, {X: 31.00, Y: 25.30}, {X: 30.00, Y: 27.30}, {X: 29.00, Y: 28.30}, {X: 28.00, Y: 29.30}, {X: 27.00, Y: 30.30}, {X: 26.00, Y: 30.30}, {X: 25.00, Y: 31.30}, {X: 24.00, Y: 31.30}, {X: 23.00, Y: 31.30}, {X: 22.00, Y: 31.30}, {X: 21.00, Y: 30.30}, {X: 20.00, Y: 30.30}, {X: 20.00, Y: 29.30}, {X: 19.00, Y: 29.30}, {X: 19.00, Y: 28.30}, {X: 18.00, Y: 27.30}, {X: 18.00, Y: 26.30},
	}},
	{{
		{X: 21.00, Y: 8.30}, {X: 21.00, Y: 7.30}, {X: 21.00, Y: 8.30}, {X: 21.00, Y: 9.30}, {X: 21.00, Y: 11.30}, {X: 22.00, Y: 13.30}, {X: 22.00, Y: 16.30}, {X: 23.00, Y: 19.30}, {X: 23.00, Y: 22.30}, {X: 24.00, Y: 24.30}, {X: 24.00, Y: 26.30}, {X: 24.00, Y: 27.30}, {X: 25.00, Y: 29.30}, {X: 25.00, Y: 28.30}, {X: 25.00, Y: 27.30}, {X: 25.00, Y: 26.30}, {X: 25.00, Y: 25.30}, {X: 26.00, Y: 23.30}, {X: 26.00, Y: 22.30}, {X: 26.00, Y: 21.30}, {X: 27.00, Y: 20.30}, {X: 28.00, Y: 20.30}, {X: 29.00, Y: 20.30}, {X: 30.00, Y: 22.30}, {X: 31.00, Y: 23.30}, {X: 32.00, Y: 25.30}, {X: 33.00, Y: 26.30}, {X: 33.00, Y: 28.30}, {X: 33.00, Y: 30.30}, {X: 32.00, Y: 31.30}, {X: 32.00, Y: 32.30}, {X: 30.00, Y: 33.30}, {X: 29.00, Y: 34.30}, {X: 28.00, Y: 35.30}, {X: 26.00, Y: 35.30}, {X: 25.00, Y: 35.30}, {X: 23.00, Y: 35.30}, {X: 22.00, Y: 34.30}, {X: 21.00, Y: 33.30}, {X: 20.00, Y: 32.30}, {X: 19.00, Y: 31.30}, {X: 19.00, Y: 30.30}, {X: 19.00, Y: 29.30}, {X: 20.00, Y: 29.30},
	}},
	{{
		{X: 14.00, Y: 2.30}, {X: 14.00, Y: 4.30}, {X: 14.00, Y: 5.30}, {X: 15.00, Y: 8.30}, {X: 15.00, Y: 10.30}, {X: 16.00, Y: 13.30}, {X: 16.00, Y: 16.30}, {X: 17.00, Y: 19.30}, {X: 17.00, Y: 21.30}, {X: 18.00, Y: 24.30}, {X: 18.00, Y: 25.30}, {X: 18.00, Y: 26.30}, {X: 18.00, Y: 27.30}, {X: 19.00, Y: 28.30}, {X: 19.00, Y: 27.30}, {X: 19.00, Y: 26.30}, {X: 18.00, Y: 25.30}, {X: 18.00, Y: 24.30}, {X: 18.00, Y: 23.30}, {X: 18.00, Y: 22.30}, {X: 19.00, Y: 22.30}, {X: 19.00, Y: 21.30}, {X: 20.00, Y: 22.30}, {X: 21.00, Y: 22.30}, {X: 23.00, Y: 23.30}, {X: 24.00, Y: 25.30}, {X: 25.00, Y: 27.30}, {X: 26.00, Y: 28.30}, {X: 26.00, Y: 29.30}, {X: 26.00, Y: 31.30}, {X: 26.00, Y: 32.30}, {X: 26.00, Y: 33.30}, {X: 25.00, Y: 33.30}, {X: 24.00, Y: 34.30}, {X: 23.00, Y: 34.30}, {X: 22.00, Y: 34.30}, {X: 21.00, Y: 33.30}, {X: 19.00, Y: 32.30}, {X: 18.00, Y: 31.30}, {X: 17.00, Y: 30.30}, {X: 17.00, Y: 29.30}, {X: 16.00, Y: 28.30}, {X: 16.00, Y: 27.30}, {X: 15.00, Y: 27.30}, {X: 16.00, Y: 26.30},
	}},
}

var symbols_2 = []Symbol{
	{{
		{X: 18.00, Y: 10.30}, {X: 18.00, Y: 9.30}, {X: 18.00, Y: 8.30}, {X: 18.00, Y: 7.30}, {X: 18.00, Y: 6.30}, {X: 18.00, Y: 5.30}, {X: 19.00, Y: 4.30}, {X: 19.00, Y: 5.30}, {X: 20.00, Y: 5.30}, {X: 21.00, Y: 7.30}, {X: 22.00, Y: 8.30}, {X: 22.00, Y: 11.30}, {X: 23.00, Y: 13.30}, {X: 23.00, Y: 16.30}, {X: 23.00, Y: 19.30}, {X: 23.00, Y: 21.30}, {X: 22.00, Y: 23.30}, {X: 21.00, Y: 25.30}, {X: 20.00, Y: 27.30}, {X: 20.00, Y: 29.30}, {X: 19.00, Y: 30.30}, {X: 18.00, Y: 30.30}, {X: 17.00, Y: 31.30}, {X: 16.00, Y: 31.30}, {X: 17.00, Y: 30.30}, {X: 18.00, Y: 30.30}, {X: 19.00, Y: 30.30}, {X: 20.00, Y: 31.30}, {X: 21.00, Y: 31.30}, {X: 22.00, Y: 32.30}, {X: 23.00, Y: 32.30}, {X: 24.00, Y: 33.30}, {X: 25.00, Y: 33.30}, {X: 26.00, Y: 32.30}, {X: 26.00, Y: 31.30}, {X: 26.00, Y: 30.30}, {X: 26.00, Y: 29.30}, {X: 26.00, Y: 28.30}, {X: 26.00, Y: 27.30}, {X: 26.00, Y: 28.30},
	}},
	{{
		{X: 17.00, Y: 13.30}, {X: 17.00, Y: 12.30}, {X: 17.00, Y: 11.30}, {X: 17.00, Y: 10.30}, {X: 17.00, Y: 9.30}, {X: 18.00, Y: 8.30}, {X: 18.00, Y: 7.30}, {X: 19.00, Y: 6.30}, {X: 20.00, Y: 6.30}, {X: 20.00, Y: 7.30}, {X: 21.00, Y: 8.30}, {X: 21.00, Y: 10.30}, {X: 22.00, Y: 13.30}, {X: 22.00, Y: 15.30}, {X: 22.00, Y: 18.30}, {X: 22.00, Y: 20.30}, {X: 22.00, Y: 23.30}, {X: 21.00, Y: 24.30}, {X: 21.00, Y: 26.30}, {X: 21.00, Y: 27.30}, {X: 20.00, Y: 28.30}, {X: 19.00, Y: 29.30}, {X: 18.00, Y: 29.30}, {X: 18.00, Y: 30.30}, {X: 17.00, Y: 30.30}, {X: 17.00, Y: 31.30}, {X: 17.00, Y: 32.30}, {X: 17.00, Y: 33.30}, {X: 18.00, Y: 34.30}, {X: 19.00, Y: 35.30}, {X: 19.00, Y: 36.30}, {X: 20.00, Y: 36.30}, {X: 21.00, Y: 36.30}, {X: 22.00, Y: 35.30}, {X: 23.00, Y: 34.30}, {X: 23.00, Y: 33.30}, {X: 23.00, Y: 32.30}, {X: 23.00, Y: 31.30}, {X: 24.00, Y: 30.30}, {X: 24.00, Y: 29.30}, {X: 25.00, Y: 29.30},
	}},
	{{
		{X: 19.00, Y: 10.30}, {X: 19.00, Y: 9.30}, {X: 20.00, Y: 9.30}, {X: 21.00, Y: 10.30}, {X: 22.00, Y: 11.30}, {X: 23.00, Y: 13.30}, {X: 23.00, Y: 15.30}, {X: 23.00, Y: 17.30}, {X: 23.00, Y: 19.30}, {X: 23.00, Y: 21.30}, {X: 22.00, Y: 22.30}, {X: 21.00, Y: 24.30}, {X: 20.00, Y: 26.30}, {X: 20.00, Y: 27.30}, {X: 19.00, Y: 28.30}, {X: 18.00, Y: 29.30}, {X: 17.00, Y: 29.30}, {X: 16.00, Y: 29.30}, {X: 15.00, Y: 30.30}, {X: 14.00, Y: 30.30}, {X: 15.00, Y: 30.30}, {X: 16.00, Y: 30.30}, {X: 17.00, Y: 30.30}, {X: 18.00, Y: 29.30}, {X: 20.00, Y: 29.30}, {X: 21.00, Y: 29.30}, {X: 22.00, Y: 29.30}, {X: 23.00, Y: 29.30}, {X: 23.00, Y: 28.30}, {X: 24.00, Y: 28.30}, {X: 25.00, Y: 28.30}, {X: 26.00, Y: 28.30}, {X: 26.00, Y: 27.30},
	}},
}

var symbols_x = []Symbol{
	{
		// two connex components
		{
			{X: 17.00, Y: 19.30}, {X: 17.00, Y: 18.30}, {X: 18.00, Y: 18.30}, {X: 18.00, Y: 17.30}, {X: 18.00, Y: 16.30}, {X: 19.00, Y: 16.30}, {X: 19.00, Y: 15.30}, {X: 20.00, Y: 16.30}, {X: 21.00, Y: 16.30}, {X: 21.00, Y: 17.30}, {X: 22.00, Y: 17.30}, {X: 23.00, Y: 18.30}, {X: 23.00, Y: 20.30}, {X: 24.00, Y: 21.30}, {X: 24.00, Y: 22.30}, {X: 24.00, Y: 23.30}, {X: 24.00, Y: 25.30}, {X: 24.00, Y: 26.30}, {X: 23.00, Y: 27.30}, {X: 23.00, Y: 28.30}, {X: 22.00, Y: 29.30}, {X: 21.00, Y: 30.30}, {X: 20.00, Y: 31.30}, {X: 19.00, Y: 32.30}, {X: 18.00, Y: 32.30}, {X: 17.00, Y: 33.30}, {X: 17.00, Y: 32.30}, {X: 16.00, Y: 32.30}, {X: 16.00, Y: 31.30}, {X: 15.00, Y: 31.30}, {X: 15.00, Y: 30.30}, {X: 15.00, Y: 29.30}, {X: 16.00, Y: 28.30},
		},
		{
			{X: 31.00, Y: 18.30}, {X: 30.00, Y: 18.30}, {X: 29.00, Y: 18.30}, {X: 28.00, Y: 18.30}, {X: 27.00, Y: 18.30}, {X: 26.00, Y: 18.30}, {X: 26.00, Y: 19.30}, {X: 25.00, Y: 19.30}, {X: 25.00, Y: 20.30}, {X: 25.00, Y: 21.30}, {X: 24.00, Y: 21.30}, {X: 24.00, Y: 22.30}, {X: 24.00, Y: 23.30}, {X: 24.00, Y: 24.30}, {X: 24.00, Y: 25.30}, {X: 24.00, Y: 26.30}, {X: 24.00, Y: 27.30}, {X: 24.00, Y: 28.30}, {X: 24.00, Y: 29.30}, {X: 24.00, Y: 30.30}, {X: 25.00, Y: 30.30}, {X: 25.00, Y: 31.30}, {X: 26.00, Y: 31.30}, {X: 26.00, Y: 32.30}, {X: 27.00, Y: 32.30}, {X: 28.00, Y: 32.30}, {X: 29.00, Y: 32.30}, {X: 30.00, Y: 32.30}, {X: 31.00, Y: 32.30}, {X: 32.00, Y: 32.30}, {X: 32.00, Y: 31.30}, {X: 32.00, Y: 30.30}, {X: 32.00, Y: 29.30}, {X: 32.00, Y: 28.30},
		},
	},
}

func TestLookup(t *testing.T) {
	db := NewSymbolStore(map[rune]Symbol{
		'a': symbols_a[0],
		'b': symbols_b[0],
		'2': symbols_2[0],
		'x': symbols_x[0],
	})

	for _, sym := range symbols_a {
		r, _ := db.match(Record{sym})
		if r != 'a' {
			t.Fatal(string(r))
		}
	}
	for i, sym := range symbols_b {
		r, _ := db.match(Record{sym})
		if r != 'b' {
			t.Fatal(i, string(r))
		}
	}
}

func TestVisu(t *testing.T) {
	input := symbols_b[2].Union()
	ref1 := symbols_b[0].Union()
	ref2 := symbols_2[0].Union()

	shapeToPixelImg(input.normalizeTo(ref1.BoundingBox()))
	shapeToPixelImg(ref1)

	shapeToPixelImg(input.normalizeTo(ref2.BoundingBox()))
	shapeToPixelImg(ref2)

	shapeToPixelImg(input.smoothTo())
	shapeToPixelImg(ref1.smoothTo())
	shapeToPixelImg(ref2.smoothTo())
}

var i int

func shapeToPixelImg(sh Shape) {
	rect := sh.BoundingBox()
	img := image.NewGray(image.Rect(int(rect.LR.X), int(rect.LR.Y), int(rect.UL.X), int(rect.UL.Y)))
	for _, p := range sh {
		img.SetGray(int(p.X), int(p.Y), color.Gray{255})
	}
	i++
	f, err := os.Create(fmt.Sprintf("tmp%d.png", i))
	if err != nil {
		panic(err)
	}
	err = png.Encode(f, img)
	if err != nil {
		panic(err)
	}
}
