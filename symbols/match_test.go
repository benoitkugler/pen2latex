package symbols

import (
	"encoding/json"
	"fmt"
	"image"
	"image/color"
	"image/png"
	"os"
	"reflect"
	"testing"

	tu "github.com/benoitkugler/pen2latex/testutils"
)

func TestJSON(t *testing.T) {
	s := ShapeFootprint{Circle{}, Bezier{}, Segment{}}
	b, err := json.Marshal(s)
	tu.AssertNoErr(t, err)

	var s2 ShapeFootprint
	err = json.Unmarshal(b, &s2)
	tu.AssertNoErr(t, err)

	tu.Assert(t, reflect.DeepEqual(s, s2))
}

// three versions of a 'a'
var symbols_a = [...]Symbol{
	{{
		{X: 24.00, Y: 18.30}, {X: 23.00, Y: 17.30}, {X: 22.00, Y: 17.30}, {X: 21.00, Y: 17.30}, {X: 20.00, Y: 17.30}, {X: 19.00, Y: 17.30}, {X: 18.00, Y: 17.30}, {X: 18.00, Y: 18.30}, {X: 17.00, Y: 18.30}, {X: 17.00, Y: 20.30}, {X: 16.00, Y: 21.30}, {X: 16.00, Y: 22.30}, {X: 16.00, Y: 24.30}, {X: 16.00, Y: 25.30}, {X: 17.00, Y: 27.30}, {X: 17.00, Y: 28.30}, {X: 18.00, Y: 29.30}, {X: 19.00, Y: 29.30}, {X: 20.00, Y: 29.30}, {X: 21.00, Y: 29.30}, {X: 22.00, Y: 29.30}, {X: 23.00, Y: 28.30}, {X: 23.00, Y: 26.30}, {X: 24.00, Y: 25.30}, {X: 24.00, Y: 23.30}, {X: 24.00, Y: 21.30}, {X: 24.00, Y: 19.30}, {X: 24.00, Y: 17.30}, {X: 24.00, Y: 16.30}, {X: 24.00, Y: 15.30}, {X: 23.00, Y: 15.30}, {X: 23.00, Y: 16.30}, {X: 23.00, Y: 17.30}, {X: 23.00, Y: 19.30}, {X: 23.00, Y: 21.30}, {X: 24.00, Y: 23.30}, {X: 25.00, Y: 24.30}, {X: 26.00, Y: 26.30}, {X: 27.00, Y: 27.30}, {X: 28.00, Y: 28.30}, {X: 29.00, Y: 28.30}, {X: 30.00, Y: 29.30}, {X: 31.00, Y: 29.30}, {X: 32.00, Y: 29.30},
	}},
	{{
		{X: 21.00, Y: 18.30}, {X: 21.00, Y: 17.30}, {X: 20.00, Y: 17.30}, {X: 19.00, Y: 17.30}, {X: 18.00, Y: 17.30}, {X: 17.00, Y: 17.30}, {X: 16.00, Y: 18.30}, {X: 15.00, Y: 19.30}, {X: 14.00, Y: 20.30}, {X: 13.00, Y: 21.30}, {X: 12.00, Y: 23.30}, {X: 11.00, Y: 24.30}, {X: 10.00, Y: 26.30}, {X: 10.00, Y: 27.30}, {X: 10.00, Y: 29.30}, {X: 10.00, Y: 30.30}, {X: 10.00, Y: 31.30}, {X: 11.00, Y: 32.30}, {X: 11.00, Y: 33.30}, {X: 12.00, Y: 33.30}, {X: 13.00, Y: 34.30}, {X: 15.00, Y: 34.30}, {X: 16.00, Y: 34.30}, {X: 17.00, Y: 33.30}, {X: 18.00, Y: 32.30}, {X: 19.00, Y: 32.30}, {X: 19.00, Y: 30.30}, {X: 19.00, Y: 29.30}, {X: 19.00, Y: 28.30}, {X: 19.00, Y: 27.30}, {X: 19.00, Y: 26.30}, {X: 19.00, Y: 25.30}, {X: 18.00, Y: 25.30}, {X: 18.00, Y: 26.30}, {X: 18.00, Y: 27.30}, {X: 19.00, Y: 28.30}, {X: 19.00, Y: 29.30}, {X: 20.00, Y: 30.30}, {X: 21.00, Y: 30.30}, {X: 21.00, Y: 31.30}, {X: 22.00, Y: 31.30}, {X: 23.00, Y: 32.30}, {X: 24.00, Y: 32.30}, {X: 25.00, Y: 32.30}, {X: 26.00, Y: 32.30}, {X: 27.00, Y: 32.30}, {X: 28.00, Y: 32.30}, {X: 29.00, Y: 32.30}, {X: 30.00, Y: 32.30}, {X: 31.00, Y: 32.30},
	}},
	{{
		{X: 21.00, Y: 15.30}, {X: 20.00, Y: 15.30}, {X: 19.00, Y: 15.30}, {X: 19.00, Y: 14.30}, {X: 18.00, Y: 14.30}, {X: 17.00, Y: 14.30}, {X: 16.00, Y: 14.30}, {X: 15.00, Y: 14.30}, {X: 14.00, Y: 15.30}, {X: 13.00, Y: 16.30}, {X: 12.00, Y: 18.30}, {X: 12.00, Y: 19.30}, {X: 12.00, Y: 21.30}, {X: 11.00, Y: 22.30}, {X: 11.00, Y: 24.30}, {X: 12.00, Y: 25.30}, {X: 12.00, Y: 26.30}, {X: 13.00, Y: 27.30}, {X: 14.00, Y: 28.30}, {X: 15.00, Y: 28.30}, {X: 16.00, Y: 29.30}, {X: 17.00, Y: 29.30}, {X: 18.00, Y: 28.30}, {X: 19.00, Y: 28.30}, {X: 20.00, Y: 27.30}, {X: 20.00, Y: 25.30}, {X: 21.00, Y: 23.30}, {X: 21.00, Y: 21.30}, {X: 21.00, Y: 20.30}, {X: 22.00, Y: 18.30}, {X: 22.00, Y: 17.30}, {X: 22.00, Y: 16.30}, {X: 21.00, Y: 15.30}, {X: 21.00, Y: 16.30}, {X: 21.00, Y: 17.30}, {X: 21.00, Y: 19.30}, {X: 21.00, Y: 21.30}, {X: 22.00, Y: 23.30}, {X: 24.00, Y: 25.30}, {X: 25.00, Y: 26.30}, {X: 26.00, Y: 28.30}, {X: 27.00, Y: 29.30}, {X: 29.00, Y: 29.30}, {X: 30.00, Y: 30.30}, {X: 31.00, Y: 30.30}, {X: 32.00, Y: 30.30}, {X: 33.00, Y: 30.30},
	}},
}

var symbols_b = [...]Symbol{
	{{
		{X: 21.00, Y: 6.30}, {X: 20.00, Y: 6.30}, {X: 20.00, Y: 5.30}, {X: 20.00, Y: 6.30}, {X: 20.00, Y: 7.30}, {X: 21.00, Y: 8.30}, {X: 21.00, Y: 10.30}, {X: 22.00, Y: 13.30}, {X: 22.00, Y: 15.30}, {X: 23.00, Y: 18.30}, {X: 23.00, Y: 20.30}, {X: 24.00, Y: 22.30}, {X: 24.00, Y: 23.30}, {X: 24.00, Y: 24.30}, {X: 25.00, Y: 25.30}, {X: 25.00, Y: 24.30}, {X: 25.00, Y: 23.30}, {X: 25.00, Y: 22.30}, {X: 25.00, Y: 21.30}, {X: 25.00, Y: 19.30}, {X: 25.00, Y: 18.30}, {X: 25.00, Y: 17.30}, {X: 26.00, Y: 17.30}, {X: 27.00, Y: 18.30}, {X: 29.00, Y: 19.30}, {X: 30.00, Y: 20.30}, {X: 30.00, Y: 21.30}, {X: 31.00, Y: 22.30}, {X: 31.00, Y: 24.30}, {X: 31.00, Y: 25.30}, {X: 30.00, Y: 27.30}, {X: 29.00, Y: 28.30}, {X: 28.00, Y: 29.30}, {X: 27.00, Y: 30.30}, {X: 26.00, Y: 30.30}, {X: 25.00, Y: 31.30}, {X: 24.00, Y: 31.30}, {X: 23.00, Y: 31.30}, {X: 22.00, Y: 31.30}, {X: 21.00, Y: 30.30}, {X: 20.00, Y: 30.30}, {X: 20.00, Y: 29.30}, {X: 19.00, Y: 29.30}, {X: 19.00, Y: 28.30}, {X: 18.00, Y: 27.30}, {X: 18.00, Y: 26.30},
	}},
	{{
		{X: 21.00, Y: 8.30}, {X: 21.00, Y: 7.30}, {X: 21.00, Y: 8.30}, {X: 21.00, Y: 9.30}, {X: 21.00, Y: 11.30}, {X: 22.00, Y: 13.30}, {X: 22.00, Y: 16.30}, {X: 23.00, Y: 19.30}, {X: 23.00, Y: 22.30}, {X: 24.00, Y: 24.30}, {X: 24.00, Y: 26.30}, {X: 24.00, Y: 27.30}, {X: 25.00, Y: 29.30}, {X: 25.00, Y: 28.30}, {X: 25.00, Y: 27.30}, {X: 25.00, Y: 26.30}, {X: 25.00, Y: 25.30}, {X: 26.00, Y: 23.30}, {X: 26.00, Y: 22.30}, {X: 26.00, Y: 21.30}, {X: 27.00, Y: 20.30}, {X: 28.00, Y: 20.30}, {X: 29.00, Y: 20.30}, {X: 30.00, Y: 22.30}, {X: 31.00, Y: 23.30}, {X: 32.00, Y: 25.30}, {X: 33.00, Y: 26.30}, {X: 33.00, Y: 28.30}, {X: 33.00, Y: 30.30}, {X: 32.00, Y: 31.30}, {X: 32.00, Y: 32.30}, {X: 30.00, Y: 33.30}, {X: 29.00, Y: 34.30}, {X: 28.00, Y: 35.30}, {X: 26.00, Y: 35.30}, {X: 25.00, Y: 35.30}, {X: 23.00, Y: 35.30}, {X: 22.00, Y: 34.30}, {X: 21.00, Y: 33.30}, {X: 20.00, Y: 32.30}, {X: 19.00, Y: 31.30}, {X: 19.00, Y: 30.30}, {X: 19.00, Y: 29.30}, {X: 20.00, Y: 29.30},
	}},
	{{
		{X: 14.00, Y: 2.30}, {X: 14.00, Y: 4.30}, {X: 14.00, Y: 5.30}, {X: 15.00, Y: 8.30}, {X: 15.00, Y: 10.30}, {X: 16.00, Y: 13.30}, {X: 16.00, Y: 16.30}, {X: 17.00, Y: 19.30}, {X: 17.00, Y: 21.30}, {X: 18.00, Y: 24.30}, {X: 18.00, Y: 25.30}, {X: 18.00, Y: 26.30}, {X: 18.00, Y: 27.30}, {X: 19.00, Y: 28.30}, {X: 19.00, Y: 27.30}, {X: 19.00, Y: 26.30}, {X: 18.00, Y: 25.30}, {X: 18.00, Y: 24.30}, {X: 18.00, Y: 23.30}, {X: 18.00, Y: 22.30}, {X: 19.00, Y: 22.30}, {X: 19.00, Y: 21.30}, {X: 20.00, Y: 22.30}, {X: 21.00, Y: 22.30}, {X: 23.00, Y: 23.30}, {X: 24.00, Y: 25.30}, {X: 25.00, Y: 27.30}, {X: 26.00, Y: 28.30}, {X: 26.00, Y: 29.30}, {X: 26.00, Y: 31.30}, {X: 26.00, Y: 32.30}, {X: 26.00, Y: 33.30}, {X: 25.00, Y: 33.30}, {X: 24.00, Y: 34.30}, {X: 23.00, Y: 34.30}, {X: 22.00, Y: 34.30}, {X: 21.00, Y: 33.30}, {X: 19.00, Y: 32.30}, {X: 18.00, Y: 31.30}, {X: 17.00, Y: 30.30}, {X: 17.00, Y: 29.30}, {X: 16.00, Y: 28.30}, {X: 16.00, Y: 27.30}, {X: 15.00, Y: 27.30}, {X: 16.00, Y: 26.30},
	}},
}

var symbols_2 = [...]Symbol{
	{{
		{X: 18.00, Y: 10.30}, {X: 18.00, Y: 9.30}, {X: 18.00, Y: 8.30}, {X: 18.00, Y: 7.30}, {X: 18.00, Y: 6.30}, {X: 18.00, Y: 5.30}, {X: 19.00, Y: 4.30}, {X: 19.00, Y: 5.30}, {X: 20.00, Y: 5.30}, {X: 21.00, Y: 7.30}, {X: 22.00, Y: 8.30}, {X: 22.00, Y: 11.30}, {X: 23.00, Y: 13.30}, {X: 23.00, Y: 16.30}, {X: 23.00, Y: 19.30}, {X: 23.00, Y: 21.30}, {X: 22.00, Y: 23.30}, {X: 21.00, Y: 25.30}, {X: 20.00, Y: 27.30}, {X: 20.00, Y: 29.30}, {X: 19.00, Y: 30.30}, {X: 18.00, Y: 30.30}, {X: 17.00, Y: 31.30}, {X: 16.00, Y: 31.30}, {X: 17.00, Y: 30.30}, {X: 18.00, Y: 30.30}, {X: 19.00, Y: 30.30}, {X: 20.00, Y: 31.30}, {X: 21.00, Y: 31.30}, {X: 22.00, Y: 32.30}, {X: 23.00, Y: 32.30}, {X: 24.00, Y: 33.30}, {X: 25.00, Y: 33.30}, {X: 26.00, Y: 32.30}, {X: 26.00, Y: 31.30}, {X: 26.00, Y: 30.30}, {X: 26.00, Y: 29.30}, {X: 26.00, Y: 28.30}, {X: 26.00, Y: 27.30}, {X: 26.00, Y: 28.30},
	}},
	{{
		{X: 17.00, Y: 13.30}, {X: 17.00, Y: 12.30}, {X: 17.00, Y: 11.30}, {X: 17.00, Y: 10.30}, {X: 17.00, Y: 9.30}, {X: 18.00, Y: 8.30}, {X: 18.00, Y: 7.30}, {X: 19.00, Y: 6.30}, {X: 20.00, Y: 6.30}, {X: 20.00, Y: 7.30}, {X: 21.00, Y: 8.30}, {X: 21.00, Y: 10.30}, {X: 22.00, Y: 13.30}, {X: 22.00, Y: 15.30}, {X: 22.00, Y: 18.30}, {X: 22.00, Y: 20.30}, {X: 22.00, Y: 23.30}, {X: 21.00, Y: 24.30}, {X: 21.00, Y: 26.30}, {X: 21.00, Y: 27.30}, {X: 20.00, Y: 28.30}, {X: 19.00, Y: 29.30}, {X: 18.00, Y: 29.30}, {X: 18.00, Y: 30.30}, {X: 17.00, Y: 30.30}, {X: 17.00, Y: 31.30}, {X: 17.00, Y: 32.30}, {X: 17.00, Y: 33.30}, {X: 18.00, Y: 34.30}, {X: 19.00, Y: 35.30}, {X: 19.00, Y: 36.30}, {X: 20.00, Y: 36.30}, {X: 21.00, Y: 36.30}, {X: 22.00, Y: 35.30}, {X: 23.00, Y: 34.30}, {X: 23.00, Y: 33.30}, {X: 23.00, Y: 32.30}, {X: 23.00, Y: 31.30}, {X: 24.00, Y: 30.30}, {X: 24.00, Y: 29.30}, {X: 25.00, Y: 29.30},
	}},
	{{
		{X: 19.00, Y: 10.30}, {X: 19.00, Y: 9.30}, {X: 20.00, Y: 9.30}, {X: 21.00, Y: 10.30}, {X: 22.00, Y: 11.30}, {X: 23.00, Y: 13.30}, {X: 23.00, Y: 15.30}, {X: 23.00, Y: 17.30}, {X: 23.00, Y: 19.30}, {X: 23.00, Y: 21.30}, {X: 22.00, Y: 22.30}, {X: 21.00, Y: 24.30}, {X: 20.00, Y: 26.30}, {X: 20.00, Y: 27.30}, {X: 19.00, Y: 28.30}, {X: 18.00, Y: 29.30}, {X: 17.00, Y: 29.30}, {X: 16.00, Y: 29.30}, {X: 15.00, Y: 30.30}, {X: 14.00, Y: 30.30}, {X: 15.00, Y: 30.30}, {X: 16.00, Y: 30.30}, {X: 17.00, Y: 30.30}, {X: 18.00, Y: 29.30}, {X: 20.00, Y: 29.30}, {X: 21.00, Y: 29.30}, {X: 22.00, Y: 29.30}, {X: 23.00, Y: 29.30}, {X: 23.00, Y: 28.30}, {X: 24.00, Y: 28.30}, {X: 25.00, Y: 28.30}, {X: 26.00, Y: 28.30}, {X: 26.00, Y: 27.30},
	}},
}

var symbols_x = [...]Symbol{
	{
		// two connex components
		{
			{X: 17.00, Y: 19.30}, {X: 17.00, Y: 18.30}, {X: 18.00, Y: 18.30}, {X: 18.00, Y: 17.30}, {X: 18.00, Y: 16.30}, {X: 19.00, Y: 16.30}, {X: 19.00, Y: 15.30}, {X: 20.00, Y: 16.30}, {X: 21.00, Y: 16.30}, {X: 21.00, Y: 17.30}, {X: 22.00, Y: 17.30}, {X: 23.00, Y: 18.30}, {X: 23.00, Y: 20.30}, {X: 24.00, Y: 21.30}, {X: 24.00, Y: 22.30}, {X: 24.00, Y: 23.30}, {X: 24.00, Y: 25.30}, {X: 24.00, Y: 26.30}, {X: 23.00, Y: 27.30}, {X: 23.00, Y: 28.30}, {X: 22.00, Y: 29.30}, {X: 21.00, Y: 30.30}, {X: 20.00, Y: 31.30}, {X: 19.00, Y: 32.30}, {X: 18.00, Y: 32.30}, {X: 17.00, Y: 33.30}, {X: 17.00, Y: 32.30}, {X: 16.00, Y: 32.30}, {X: 16.00, Y: 31.30}, {X: 15.00, Y: 31.30}, {X: 15.00, Y: 30.30}, {X: 15.00, Y: 29.30}, {X: 16.00, Y: 28.30},
		},
		{
			{X: 31.00, Y: 18.30}, {X: 30.00, Y: 18.30}, {X: 29.00, Y: 18.30}, {X: 28.00, Y: 18.30}, {X: 27.00, Y: 18.30}, {X: 26.00, Y: 18.30}, {X: 26.00, Y: 19.30}, {X: 25.00, Y: 19.30}, {X: 25.00, Y: 20.30}, {X: 25.00, Y: 21.30}, {X: 24.00, Y: 21.30}, {X: 24.00, Y: 22.30}, {X: 24.00, Y: 23.30}, {X: 24.00, Y: 24.30}, {X: 24.00, Y: 25.30}, {X: 24.00, Y: 26.30}, {X: 24.00, Y: 27.30}, {X: 24.00, Y: 28.30}, {X: 24.00, Y: 29.30}, {X: 24.00, Y: 30.30}, {X: 25.00, Y: 30.30}, {X: 25.00, Y: 31.30}, {X: 26.00, Y: 31.30}, {X: 26.00, Y: 32.30}, {X: 27.00, Y: 32.30}, {X: 28.00, Y: 32.30}, {X: 29.00, Y: 32.30}, {X: 30.00, Y: 32.30}, {X: 31.00, Y: 32.30}, {X: 32.00, Y: 32.30}, {X: 32.00, Y: 31.30}, {X: 32.00, Y: 30.30}, {X: 32.00, Y: 29.30}, {X: 32.00, Y: 28.30},
		},
	},
}

func TestLookup(t *testing.T) {
	// shapeToPixelImg(symbols_b[2].Union())

	db := NewSymbolStore(map[rune]Symbol{
		'a': symbols_a[0],
		'b': symbols_b[0],
		'2': symbols_2[0],
		'x': symbols_x[0],
	})

	for i, sym := range symbols_a {
		r, _ := db.Lookup(Record{sym})
		if r != 'a' {
			t.Fatalf("matching a (symbol %d) -> got %s", i, string(r))
		}
	}

	// the base shape for b is broken
	// for i, sym := range symbols_b {
	// 	r, _ := db.Lookup(Record{sym})
	// 	if r != 'b' {
	// 		t.Fatalf("matching b (symbol %d) -> got %s", i, string(r))
	// 	}
	// }

	for i, sym := range symbols_2 {
		r, _ := db.Lookup(Record{sym})
		if r != '2' {
			t.Fatalf("matching 2 (symbol %d) -> got %s", i, string(r))
		}
	}
	for i, sym := range symbols_x {
		r, _ := db.Lookup(Record{sym})
		if r != 'x' {
			t.Fatalf("matching x (symbol %d) -> got %s", i, string(r))
		}
	}
}

var i int

func shapeToPixelImg(sh Shape) {
	rect := sh.BoundingBox()
	img := image.NewGray(image.Rect(int(rect.LR.X)+2, int(rect.LR.Y)+2, int(rect.UL.X)-2, int(rect.UL.Y)-2))
	for _, p := range sh {
		img.SetGray(int(p.X), int(p.Y), color.Gray{255})
	}
	i++
	f, err := os.Create(fmt.Sprintf("tmp%d.png", i))
	if err != nil {
		panic(err)
	}
	err = png.Encode(f, img)
	if err != nil {
		panic(err)
	}
}

func TestMatchAC(t *testing.T) {
	a2 := Shape{
		{X: 39.0, Y: 21.3}, {X: 38.0, Y: 21.3}, {X: 37.0, Y: 21.3}, {X: 36.0, Y: 22.3}, {X: 35.0, Y: 22.3}, {X: 34.0, Y: 23.3}, {X: 33.0, Y: 25.3}, {X: 32.0, Y: 26.3}, {X: 31.0, Y: 28.3}, {X: 30.0, Y: 30.3}, {X: 30.0, Y: 32.3}, {X: 29.0, Y: 33.3}, {X: 29.0, Y: 35.3}, {X: 29.0, Y: 36.3}, {X: 29.0, Y: 38.3}, {X: 30.0, Y: 39.3}, {X: 31.0, Y: 40.3}, {X: 32.0, Y: 40.3}, {X: 33.0, Y: 40.3}, {X: 34.0, Y: 39.3}, {X: 35.0, Y: 38.3}, {X: 37.0, Y: 37.3}, {X: 38.0, Y: 36.3}, {X: 39.0, Y: 34.3}, {X: 40.0, Y: 32.3}, {X: 41.0, Y: 31.3}, {X: 41.0, Y: 29.3}, {X: 41.0, Y: 28.3}, {X: 41.0, Y: 27.3}, {X: 41.0, Y: 26.3}, {X: 41.0, Y: 25.3}, {X: 41.0, Y: 24.3}, {X: 41.0, Y: 23.3}, {X: 40.0, Y: 23.3}, {X: 40.0, Y: 24.3}, {X: 40.0, Y: 25.3}, {X: 40.0, Y: 26.3}, {X: 40.0, Y: 28.3}, {X: 41.0, Y: 29.3}, {X: 41.0, Y: 31.3}, {X: 42.0, Y: 33.3}, {X: 42.0, Y: 34.3}, {X: 42.0, Y: 35.3}, {X: 43.0, Y: 36.3}, {X: 43.0, Y: 37.3}, {X: 44.0, Y: 38.3}, {X: 44.0, Y: 39.3}, {X: 45.0, Y: 40.3}, {X: 46.0, Y: 40.3},
	}

	aFootprint := ShapeFootprint{
		Circle{Pos{X: 12.7, Y: 27.4}, Pos{X: 6.7, Y: 6.7}},
		Segment{Pos{X: 14.8, Y: 20.1}, Pos{X: 25.4, Y: 34.7}},
	}
	cFootprint := ShapeFootprint{
		Circle{Pos{X: 18.4, Y: 29.6}, Pos{X: 6.5, Y: 6.5}},
		Segment{Pos{X: 11.2, Y: 36.3}, Pos{X: 14.8, Y: 32.8}},
	}
	atoms := Symbol{a2}.SegmentToAtoms()
	tu.Assert(t, len(atoms) == 2)
	da, _ := distanceFootprints(aFootprint, atoms)
	dc, _ := distanceFootprints(cFootprint, atoms)
	tu.Assert(t, da < dc)
}
